# Устранение неполадок ComToAir

## Проблема: UART активен, но данные не поступают

### Шаг 1: Проверка логов через последовательный порт

Подключите устройство к компьютеру через USB и откройте монитор последовательного порта:

```bash
pio device monitor
```

Или используйте кнопку "Monitor" в PlatformIO.

**Что искать в логах:**
- `UART initialized: RX=GPIO0 (A0), TX=GPIO1 (A1), Baud=115200` - подтверждение инициализации
- `Test message sent to UART` - тестовое сообщение отправлено
- `UART read task started` - задача чтения запущена
- `Data available in buffer: X bytes` - данные в буфере (если есть)
- `Received X bytes` - данные получены
- `UART waiting for data...` - ожидание данных (нормально, если нет входящих данных)

### Шаг 2: Проверка веб-интерфейса

1. Подключитесь к WiFi точке доступа `ComToAir_AP` (пароль: `12345678`)
2. Откройте браузер и перейдите на `http://192.168.4.1`
3. Проверьте статус UART в интерфейсе
4. Откройте консоль разработчика (F12) и проверьте ответы API:
   - `GET /api/data` - последние данные
   - `GET /api/uart/status` - статус UART и статистика

### Шаг 3: Проверка подключения

**Проверьте физическое подключение:**
```
USB-UART PL2303TA              XIAO ESP32-C6
─────────────────              ────────────────
Белый провод (TX) ───────────> A0 (GPIO 0, RX) ✓
Зеленый провод (RX) <───────── A1 (GPIO 1, TX) ✓
Черный провод (GND) ────────── GND ✓
Красный провод (VCC) ───────── НЕ ПОДКЛЮЧАТЬ ✓
```

**Важно:**
- Убедитесь, что провода надежно подключены
- Проверьте, что нет короткого замыкания
- Убедитесь, что красный провод (VCC) НЕ подключен

### Шаг 4: Проверка скорости передачи данных

По умолчанию используется скорость **115200 бод**. Если ваше устройство передает данные с другой скоростью, нужно изменить настройки.

**Проверьте настройки USB-UART преобразователя:**
- Убедитесь, что на компьютере (если используется терминал) скорость установлена на 115200
- Проверьте настройки устройства, которое отправляет данные

**Возможные скорости для тестирования:**
- 9600 бод
- 19200 бод
- 38400 бод
- 57600 бод
- 115200 бод (по умолчанию)

### Шаг 5: Тестовая отправка данных

**С компьютера через терминал:**
1. Подключите USB-UART преобразователь к компьютеру
2. Откройте терминал (например, `screen` или `minicom`):
   ```bash
   screen /dev/ttyUSB0 115200
   # или
   minicom -D /dev/ttyUSB0 -b 115200
   ```
3. Введите любой текст и нажмите Enter
4. Проверьте логи ESP32 - должны появиться сообщения о полученных данных

**На macOS:**
```bash
screen /dev/tty.usbserial-* 115200
# или используйте приложение Serial Monitor
```

### Шаг 6: Проверка буфера UART

В веб-интерфейсе проверьте:
- `buffered_bytes` - количество байт в буфере UART
- `total_received` - общее количество полученных байт
- Если `buffered_bytes > 0`, но данные не отображаются, возможно проблема в обработке

### Шаг 7: Диагностика через API

**Проверка статуса UART:**
```bash
curl http://192.168.4.1/api/uart/status
```

Ожидаемый ответ:
```json
{
  "uart_active": true,
  "rx_pin": 0,
  "tx_pin": 1,
  "baud_rate": 115200,
  "buffered_bytes": 0,
  "total_received": 0,
  "buffer_size": 1024
}
```

**Проверка данных:**
```bash
curl http://192.168.4.1/api/data
```

### Шаг 8: Возможные проблемы и решения

#### Проблема: Данные не поступают вообще

**Возможные причины:**
1. Неправильное подключение проводов (TX/RX перепутаны)
2. Несовпадение скорости передачи данных
3. Проблемы с питанием (убедитесь, что устройство получает достаточное питание)
4. Проблемы с USB-UART преобразователем

**Решения:**
- Проверьте подключение проводов
- Попробуйте другую скорость передачи данных
- Проверьте USB-UART преобразователь на другом устройстве
- Убедитесь, что устройство стабильно работает (WiFi точка доступа доступна)

#### Проблема: Данные поступают, но не отображаются в веб-интерфейсе

**Возможные причины:**
1. Проблемы с буферизацией
2. Данные перезаписываются слишком быстро
3. Проблемы с JSON форматированием

**Решения:**
- Проверьте логи через последовательный порт
- Обновите веб-страницу
- Проверьте консоль браузера на наличие ошибок JavaScript

#### Проблема: Частичная потеря данных

**Возможные причины:**
1. Буфер переполняется
2. Скорость обработки недостаточна
3. Прерывания обрабатываются слишком долго

**Решения:**
- Увеличьте размер буфера в `config.h`
- Уменьшите скорость передачи данных
- Оптимизируйте код обработки

### Шаг 9: Расширенная диагностика

Если проблема не решена, включите подробное логирование:

1. В коде уже включено подробное логирование
2. Проверьте логи через последовательный порт
3. Ищите сообщения с префиксом `[ComToAir]`

**Типичные сообщения:**
- `UART initialized` - UART инициализирован
- `Test message sent to UART` - тестовое сообщение отправлено
- `UART read task started` - задача чтения запущена
- `Data available in buffer: X bytes` - данные в буфере
- `Received X bytes` - данные получены
- `Hex: XX XX XX` - данные в hex формате
- `Text: ...` - данные как текст

### Контакты для поддержки

Если проблема не решена после выполнения всех шагов:
1. Сохраните логи из последовательного порта
2. Сделайте скриншоты веб-интерфейса
3. Опишите точные шаги для воспроизведения проблемы
4. Укажите версию прошивки и конфигурацию оборудования

